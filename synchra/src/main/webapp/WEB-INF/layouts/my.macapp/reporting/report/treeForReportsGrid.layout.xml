<?xml version="1.0" encoding="utf-8" ?>

<config:template-call
	xmlns:config="http://www.top-logic.com/ns/config/6.0"
	template="com.top_logic.element/treegrid.template.xml"
>
	<arguments
		defaultColumns="name,partName,fineName,implementedBy,chapter,defines,library,price,weight,length,partArt,parts,numberOfEntities"
		model="selection(my.macapp/reporting/report/timestampsForReportsTable.layout.xml#Table)"
		rootVisible="false"
		type="PDX.Bom:Component,PDX.Bom:LibraryNode,PDX.Bom:ConstructionPart"
	>
		<name key="dynamic.6f699589-314f-421b-a828-3d865637d453">
			<en>Tree for Reports</en>
			<de>Differenzen historisch/aktuell</de>
		</name>
		<modelBuilder class="com.top_logic.model.search.providers.TreeModelByExpression"
			leafPredicate="false"
			nodePredicate="node->$node.instanceOf(`PDX.Bom:LibraryNode`) || $node.instanceOf(`PDX.Bom:Component`) || $node.instanceOf(`PDX.Bom:ConstructionPart`)"
			parents="node->$node.container()"
			rootNode="`PDX.Bom#PRODUCTS`"
		>
			<children><![CDATA[node -> switch {
      $node.instanceOf(`PDX.Bom:Structure`): $node.get(`PDX.Bom:Structure#contents`);
      $node.instanceOf(`PDX.Bom:Chapter`): $node.get(`PDX.Bom:Chapter#defines`).filter(elt->$elt.instanceOf(`PDX.Bom:Composition`));
      $node.instanceOf(`PDX.Bom:Composition`): $node.get(`PDX.Bom:Composition#parts`);
      $node.instanceOf(`PDX.Bom:ConstructionPart`):$node.get(`PDX.Bom:ConstructionPart#implementedBy`).get(`PDX.Bom:Composition#parts`);
      }]]></children>
		</modelBuilder>
		<configurationProviders>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				columnId="ID_d13a3b0e_a831_4613_b9e4_d5a3c6bb124e"
				columnType="tl.core:Double"
			>
				<columnLabel key="dynamic.11ed7a77-1c65-46f0-ba03-de5d37cd08e8">
					<en>historical Price</en>
					<de>historischer Preis</de>
				</columnLabel>
				<accessor><![CDATA[x->model->switch{$x.instanceOf(`PDX.Bom:Composition`):$x.inRevision($model.get(`PDX.Report:Report#revisions`)).get(`PDX.Bom:Composition#price`);
                 $x.instanceOf(`PDX.Bom:ConstructionPart`):$x.inRevision($model.get(`PDX.Report:Report#revisions`)).get(`PDX.Bom:ConstructionPart#price`);}]]></accessor>
				<annotations>
					<format>
						<currency
							currency="EUR"
							pattern="#0.00 €"
						/>
					</format>
				</annotations>
			</configurationProvider>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				columnId="ID_3f313aa1_c93e_41ce_becc_3bbb5df0207a"
				columnType="tl.core:Double"
			>
				<columnLabel key="dynamic.311a3e81-9002-4b3b-9b9c-b4e32ba04ee3">
					<en>Difference</en>
					<de>Preisdifferenz</de>
					<tooltip>
						<de>zeigt die Differenz zwischen dem aktuellen und dem historischen Preis</de>
					</tooltip>
				</columnLabel>
				<accessor><![CDATA[x->model->switch{$x.instanceOf(`PDX.Bom:Composition`):$x.get(`PDX.Bom:Composition#price`)-$x.inRevision($model.get(`PDX.Report:Report#revisions`)).get(`PDX.Bom:Composition#price`);
                 $x.instanceOf(`PDX.Bom:ConstructionPart`):$x.get(`PDX.Bom:ConstructionPart#price`)-$x.inRevision($model.get(`PDX.Report:Report#revisions`)).get(`PDX.Bom:ConstructionPart#price`);}]]></accessor>
				<annotations>
					<format>
						<currency
							currency="EUR"
							pattern="#0.00 €"
						/>
					</format>
				</annotations>
			</configurationProvider>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				accessor="x->model->$x.inRevision($model.get(`PDX.Report:Report#revisions`)).get(`PDX.Bom:ConstructionPart#numberOfEntities`)"
				columnId="ID_fd3d4742_2eda_4abb_a948_438c8d0295a8"
				columnType="tl.core:Integer"
			>
				<columnLabel key="dynamic.98c0f1a5-e3e1-4352-a0ba-8719286434f8">
					<en>historical quantity</en>
					<de>Historische Menge</de>
				</columnLabel>
			</configurationProvider>
		</configurationProviders>
		<buttons>
			<button id="exportExcelGrid"
				class="com.top_logic.layout.table.export.StreamingExcelExportHandler"
			/>
			<button id="createNewRow"
				class="com.top_logic.model.search.providers.GridCreateHandlerByExpression"
				createContext="model -> $model"
				initOperation="createContext -> newObject -> target -> $createContext.add(`PDX.Bom:Composition#parts`, $newObject)"
				target="selection(self())"
			>
				<checkScopeProvider/>
				<type-options class="com.top_logic.element.layout.create.AttributeBasedCreateTypeOptions"
					attribute="PDX.Bom:Composition#parts"
					owner="PDX.Bom:Component"
				/>
			</button>
		</buttons>
	</arguments>
</config:template-call>