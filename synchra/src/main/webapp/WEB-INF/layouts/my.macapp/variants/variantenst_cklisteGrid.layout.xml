<?xml version="1.0" encoding="utf-8" ?>

<config:template-call
	xmlns:config="http://www.top-logic.com/ns/config/6.0"
	final="true"
	template="com.top_logic.element/treegrid.template.xml"
>
	<arguments
		defaultColumns="partName,name,numberOfEntities,fineName,codeRule"
		expandRoot="false"
		model="selection(my.macapp/variants/variantsTable.layout.xml#Table)"
		type="PDX.Bom:Component,PDX.Bom:ConstructionPart"
	>
		<name key="dynamic.0f262e7f-99df-4d87-9fdc-8d86a72516cc">
			<de>VariantenstÃ¼ckliste</de>
		</name>
		<modelBuilder class="com.top_logic.model.search.providers.TreeModelByExpression"
			nodePredicate="node->$node.instanceOf(`PDX.Bom:Composition`)"
			parents="node->$node.referers(`PDX.Bom:Composition#parts`)"
			rootNode="model -> $model"
		>
			<children><![CDATA[
      node -> model -> {
      parts = switch{
      $node.instanceOf(`PDX.Bom:Composition`): $node.get(`PDX.Bom:Composition#parts`);
      $node.instanceOf(`PDX.Bom:ConstructionPart`):$node.get(`PDX.Bom:ConstructionPart#implementedBy`).get(`PDX.Bom:Composition#parts`);
      default: null;
      };
      config = $model.get(`PDX.Bom:DerivedComposition#classifiers`);
      
      switch {
      $node == $model: $node.get(`PDX.Bom:DerivedComposition#master`);
      default: $parts.filter(p->{
      cond = $p.get(`PDX.Bom:ConstructionPart#codeRule`);
      condType = $cond.get(`PDX.Bom:ConstructionCondition#type`);
      condClassifiers = $cond.get(`PDX.Bom:ConstructionCondition#classifiers`);
      switch{
      $cond == null: true;
      $condType == `PDX.Bom:ConditionType#AND`: $config.containsAll($condClassifiers);
      $condType == `PDX.Bom:ConditionType#OR`: $config.containsSome($condClassifiers);
      $condType == `PDX.Bom:ConditionType#NOT`: !$config.containsSome($condClassifiers);
      default: true;
      }
      });
      };
      
      }
    ]]></children>
		</modelBuilder>
		<buttons>
			<button id="exportExcelGrid"
				class="com.top_logic.layout.table.export.StreamingExcelExportHandler"
			/>
			<button id="createNewRow"
				class="com.top_logic.model.search.providers.GridCreateHandlerByExpression"
				createContext="model -> $model"
				initOperation="createContext -> newObject -> target -> $createContext.add(`PDX.Bom:Composition#parts`, $newObject)"
				target="selection(self())"
			>
				<checkScopeProvider/>
				<type-options class="com.top_logic.element.layout.create.AttributeBasedCreateTypeOptions"
					attribute="PDX.Bom:Composition#parts"
					owner="PDX.Bom:Component"
				/>
			</button>
			<button id="ID_4283b84a_7fce_4ed3_94d9_f33e0940359d"
				class="com.top_logic.layout.form.component.InvalidateCommand"
			/>
		</buttons>
	</arguments>
</config:template-call>