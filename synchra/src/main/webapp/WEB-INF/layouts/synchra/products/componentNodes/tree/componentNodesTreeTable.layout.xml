<?xml version="1.0" encoding="utf-8" ?>

<config:template-call
	xmlns:config="http://www.top-logic.com/ns/config/6.0"
	template="com.top_logic/treetable.template.xml"
>
	<arguments
		defaultColumns="name,price,ID_84ca2c86_e001_43e5_8556_c5a4358a4f5b,ID_4f2fe934_4bf3_426e_bbe0_d73b0bf18cbf,ID_06457f75_4b0b_4e80_a7dc_0262a50bc7f3"
		rootVisible="false"
		type="syn:ComponentNode"
	>
		<name key="dynamic.6af66dc9-752b-47db-b95b-8a68cb569e12">
			<en>Produkt Tree</en>
			<de>Produktbaum</de>
		</name>
		<modelBuilder class="com.top_logic.model.search.providers.TreeModelByExpression"
			leafPredicate="false"
			nodePredicate="node->$node.instanceOf(`syn:ComponentNode`)"
			parents="node->$node.get(`syn:ComponentNode#parent`)"
			rootNode="`synchra.Bom#LIBRARIES`"
		>
			<children><![CDATA[node -> selection-> switch {
    $selection==null: null;
    $node.instanceOf(`synchra.Bom:Libraries`): {
        date = $selection.get(`syn:ProductSelection#referenceDate`);
        revision = $date==null ?  currentRevision() : revisionAt($date);
        product = $selection.get(`syn:ProductSelection#product`).inRevision($revision);
        new(`syn:ComponentNode`, transient:true)
            ..set(`syn:ComponentNode#component`, $product.get(`syn:Product#buildGroup`))
            ..set(`syn:ComponentNode#parent`, null)
            ..set(`syn:ComponentNode#connection`, null)
            ..set(`syn:ComponentNode#product`, $product);
       };
    $node.instanceOf(`syn:ComponentNode`):{
       rule = $selection.get(`syn:ProductSelection#rule`);
       $node.get(`syn:ComponentNode#component`).get(`syn:ConstructionGroup#consistsOf`)
            .filter( con -> $rule==null ? true : ( $con.get(`syn:Connection#rule`).stringContains($rule) ||  $con.get(`syn:Connection#rule`).isEmpty() )  ) 
            .map( con -> 
                  new(`syn:ComponentNode`, transient:true)
                    ..set(`syn:ComponentNode#component`, $con.get(`syn:Connection#consistsOf`))
                    ..set(`syn:ComponentNode#parent`, $node)
                    ..set(`syn:ComponentNode#connection`, $con)
                    ..set(`syn:ComponentNode#product`, $node.get(`syn:ComponentNode#product`))
            );
     };
}
]]></children>
		</modelBuilder>
		<configurationProviders>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				accessor="row -> model -> $row.get(`syn:ComponentNode#component`).get(`syn:SinglePart#material`)"
				columnId="ID_4f2fe934_4bf3_426e_bbe0_d73b0bf18cbf"
				columnType="syn:Material"
			>
				<columnLabel key="dynamic.9d1bd9fc-36d4-4ff8-97a8-30310416f8b3">
					<en>Material</en>
					<de>Material</de>
				</columnLabel>
				<annotations>
					<column-info>
						<comparator class="com.top_logic.basic.col.ComparableComparator"/>
					</column-info>
				</annotations>
			</configurationProvider>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				accessor="row -> model -> $row.get(`syn:ComponentNode#component`).get(`syn:Component#price`)"
				columnId="ID_06457f75_4b0b_4e80_a7dc_0262a50bc7f3"
				columnType="tl.core:Double"
			>
				<columnLabel key="dynamic.4d9c3695-c4f9-42b7-92ea-f6ab187fb89f">
					<en>Component-Price</en>
					<de>Komponenten-Preis</de>
				</columnLabel>
			</configurationProvider>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				accessor="row -> model -> $row.get(`syn:ComponentNode#connection`).get(`syn:Connection#countries`)"
				columnId="ID_d7cb9ace_d438_4d72_be15_b30495677e36"
				columnType="syn:Country"
			>
				<columnLabel key="dynamic.67710a65-69fb-41f1-b33b-c4b67f6494b5">
					<en>Countries</en>
					<de>LÃ¤nder</de>
				</columnLabel>
				<annotations>
					<column-info>
						<comparator class="com.top_logic.basic.col.ComparableComparator"/>
					</column-info>
				</annotations>
			</configurationProvider>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				accessor="row -> model -> $row.get(`syn:ComponentNode#connection`).get(`syn:Connection#rule`)"
				columnId="ID_84ca2c86_e001_43e5_8556_c5a4358a4f5b"
				columnType="tl.core:String"
			>
				<columnLabel key="dynamic.42bcd4a5-0625-49c2-a782-860143432be5">
					<en>Rule</en>
					<de>Regel</de>
				</columnLabel>
			</configurationProvider>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				accessor="row -> model -> $row.get(`syn:ComponentNode#connection`).get(`syn:Connection#position`)"
				columnId="ID_3a6d7b67_89f8_4592_a5bf_433ce720d33e"
				columnType="tl.core:String"
			>
				<columnLabel key="dynamic.4b2a2c9a-28fd-4d75-832e-50fbac059d87">
					<en>Position</en>
					<de>Lage</de>
				</columnLabel>
			</configurationProvider>
			<configurationProvider class="com.top_logic.model.search.providers.ComputedColumnProviderByExpression"
				accessor="row -> model -> $row.get(`syn:ComponentNode#component`).get(`syn:Component#risks`)"
				columnId="ID_830dcae4_5dc2_40fe_b25d_4d4d5b537401"
				columnType="risk:Risk"
			>
				<columnLabel key="dynamic.22c8ab2a-2551-43c1-a15d-5419a3f6de1c">
					<en>Risks</en>
					<de>Risiken</de>
				</columnLabel>
			</configurationProvider>
		</configurationProviders>
		<buttons>
			<button id="ID_1efa6053_bab5_4514_9bb3_53fa4c7bda0f"
				class="com.top_logic.layout.table.export.ExcelExportHandler"
			>
				<downloadNameKey key="dynamic.709c4bc7-2326-4b47-a4d1-567144c1578f">
					<en>Product data</en>
					<de>Produktdaten</de>
				</downloadNameKey>
			</button>
		</buttons>
	</arguments>
</config:template-call>