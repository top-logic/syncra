<?xml version="1.0" encoding="utf-8" ?>

<model xmlns="http://www.top-logic.com/ns/dynamic-types/6.0">
	<module name="fma">
		<enum name="CompanyStructure">
			<classifier name="AG"/>
			<classifier name="GmbH"/>
			<classifier name="CoKG"/>
		</enum>
		<class name="Activity">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<annotations>
				<form-definition>
					<form>
						<field
							attribute="name"
							fullQualifiedName="fma:Activity#name"
							type="tl.core:String"
						/>
						<field
							attribute="costs"
							fullQualifiedName="fma:Activity#costs"
							type="tl.core:Integer"
						/>
						<field
							attribute="riskCostImpact"
							fullQualifiedName="fma:Activity#riskCostImpact"
							type="tl.core:Integer"
						/>
						<field
							attribute="riskProbImpact"
							fullQualifiedName="fma:Activity#riskProbImpact"
							type="tl.core:Integer"
						/>
						<field
							attribute="description"
							fullQualifiedName="fma:Activity#description"
							type="tl.model.wysiwyg:Html"
						/>
					</form>
				</form-definition>
			</annotations>
			<attributes>
				<property name="name"
					mandatory="true"
					type="tl.core:String"
				/>
				<property name="description"
					type="tl.model.wysiwyg:Html"
				/>
				<property name="costs"
					type="tl.core:Integer"
				/>
				<property name="riskCostImpact"
					type="tl.core:Integer"
				/>
				<property name="riskProbImpact"
					type="tl.core:Integer"
				/>
			</attributes>
		</class>
		<class name="Company">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<annotations>
				<form-definition>
					<form>
						<static-html>
							<content><![CDATA[<p><span style="font-size:36px"><strong>Details Firmenkontakt</strong></span></p>
]]></content>
						</static-html>
						<group>
							<field
								attribute="name"
								fullQualifiedName="fma:Company#name"
								type="tl.core:String"
							/>
							<field
								attribute="structure"
								fullQualifiedName="fma:Company#structure"
								type="fma:CompanyStructure"
							/>
							<label key="dynamic.5dae300d-1547-4871-840b-5455236645ad">
								<en>Base Data</en>
								<de>Basisdaten</de>
							</label>
						</group>
						<group>
							<field
								attribute="contactPerson"
								fullQualifiedName="fma:Company#contactPerson"
								type="tl.core:String"
							/>
							<field
								attribute="phone"
								fullQualifiedName="fma:Company#phone"
								type="tl.core:String"
							/>
							<label key="dynamic.305a3563-965b-402e-a044-c7c861b71154">
								<en>Contact</en>
								<de>Kontakt</de>
							</label>
						</group>
						<other-attributes/>
					</form>
				</form-definition>
			</annotations>
			<attributes>
				<property name="name"
					mandatory="true"
					type="tl.core:String"
				/>
				<reference name="structure"
					kind="forwards"
					mandatory="true"
					navigate="true"
					type="CompanyStructure"
				/>
				<property name="contactPerson"
					type="tl.core:String"
				/>
				<property name="phone"
					type="tl.core:String"
				/>
			</attributes>
		</class>
		<interface name="Component">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<attributes>
				<property name="name"
					mandatory="true"
					type="tl.core:String"
				/>
				<reference name="used"
					inverse-reference="consistsOf"
					kind="backwards"
					multiple="true"
					navigate="true"
					type="Connection"
				/>
				<property name="price"
					type="tl.core:Double"
				/>
				<reference name="risks"
					inverse-reference="components"
					kind="backwards"
					multiple="true"
					navigate="true"
					type="risk:Risk"
				/>
			</attributes>
		</interface>
		<class name="ConstructionGroup">
			<generalizations>
				<generalization type="Component"/>
			</generalizations>
			<annotations>
				<instance-presentation icon="css:fa-solid fa-object-group"/>
				<form-definition>
					<form>
						<static-html>
							<content><![CDATA[<p><span style="font-size:36px"><strong>Details Baugruppe</strong></span></p>
]]></content>
						</static-html>
						<other-attributes/>
						<field
							attribute="name"
							fullQualifiedName="fma:Component#name"
							type="tl.core:String"
						/>
						<field
							attribute="consistsOf"
							fullQualifiedName="fma:ConstructionGroup#consistsOf"
							type="fma:Connection"
						>
							<annotations>
								<label-position value="hide-label"/>
							</annotations>
						</field>
					</form>
				</form-definition>
			</annotations>
			<attributes>
				<reference name="consistsOf"
					composite="true"
					inverse-reference="used"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="Connection"
				>
					<annotations>
						<constraints>
							<constraint class="com.top_logic.model.util.NoAttributeCycle">
								<additional-observed-references>
									<additional-observed-reference name="consistsOf"
										definition="fma:Connection"
									/>
								</additional-observed-references>
							</constraint>
						</constraints>
					</annotations>
				</reference>
				<property name="price"
					override="true"
					type="tl.core:Double"
				>
					<annotations>
						<storage-algorithm>
							<query expr="grp -> $grp.get(`fma:ConstructionGroup#consistsOf`).get(`fma:Connection#consistsOf`).get(`fma:Component#price`).sum()"/>
						</storage-algorithm>
					</annotations>
				</property>
			</attributes>
		</class>
		<class name="SinglePart">
			<generalizations>
				<generalization type="Component"/>
			</generalizations>
			<annotations>
				<instance-presentation icon="css:fa-solid fa-diamond"/>
			</annotations>
			<attributes>
				<reference name="company"
					kind="forwards"
					navigate="true"
					type="Company"
				/>
				<reference name="material"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="Material"
				/>
			</attributes>
		</class>
		<class name="ComponentNode">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<attributes>
				<reference name="component"
					kind="forwards"
					mandatory="true"
					navigate="true"
					type="Component"
				/>
				<reference name="connection"
					kind="forwards"
					navigate="true"
					type="Connection"
				/>
				<reference name="parent"
					inverse-reference="children"
					kind="forwards"
					navigate="true"
					type="ComponentNode"
				/>
				<property name="name"
					type="tl.core:String"
				>
					<annotations>
						<storage-algorithm>
							<query expr="node -> $node.get(`fma:ComponentNode#component`).isEmpty() ?$node.get(`fma:ComponentNode#product`).get(`fma:Product#name`): $node.get(`fma:ComponentNode#component`).get(`fma:Component#name`)"/>
						</storage-algorithm>
					</annotations>
				</property>
				<reference name="product"
					kind="forwards"
					type="Product"
				/>
				<reference name="children"
					inverse-reference="parent"
					kind="backwards"
					multiple="true"
					navigate="true"
					type="ComponentNode"
				/>
				<property name="price"
					type="tl.core:Double"
				>
					<annotations>
						<storage-algorithm>
							<query>
								<expr><![CDATA[node -> if( $node.get(`fma:ComponentNode#component`).instanceOf(`fma:SinglePart`),
 $node.get(`fma:ComponentNode#component`).get(`fma:SinglePart#price`),
 $node.get(`fma:ComponentNode#children`).get(`fma:ComponentNode#price`).sum()
)]]></expr>
							</query>
						</storage-algorithm>
					</annotations>
				</property>
			</attributes>
		</class>
		<class name="Connection">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<attributes>
				<reference name="used"
					aggregate="true"
					inverse-reference="consistsOf"
					kind="backwards"
					navigate="true"
					type="ConstructionGroup"
				/>
				<reference name="consistsOf"
					inverse-reference="used"
					kind="forwards"
					mandatory="true"
					navigate="true"
					type="Component"
				/>
				<property name="position"
					type="tl.core:String"
				/>
				<reference name="countries"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="Country"
				/>
				<property name="rule"
					type="tl.core:String"
				/>
			</attributes>
		</class>
		<class name="Country">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<attributes>
				<property name="name"
					mandatory="true"
					type="tl.core:String"
				/>
			</attributes>
		</class>
		<class name="Material">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<attributes>
				<property name="name"
					mandatory="true"
					type="tl.core:String"
				/>
			</attributes>
		</class>
		<class name="PartCatalog">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<attributes>
				<property name="name"
					mandatory="true"
					type="tl.core:String"
				/>
				<reference name="parts"
					composite="true"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="SinglePart"
				/>
				<reference name="partGroups"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="PartsGroup"
				>
					<annotations>
						<storage-algorithm>
							<query>
								<expr><![CDATA[catalog -> 
all(`fma:Company`).map( company -> 
        new(`fma:PartsGroup`, transient: true)
	..set(`fma:PartsGroup#name`, $company.get(`fma:Company#name`))
	..set(`fma:PartsGroup#parts`, 
	         $catalog.get(`fma:PartCatalog#parts`).filter(part -> $part.get(`fma:SinglePart#company`)==$company)
	       )  
)]]></expr>
							</query>
						</storage-algorithm>
						<create-visibility value="hidden"/>
						<visibility value="hidden"/>
					</annotations>
				</reference>
				<reference name="materialGroups"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="PartsGroup"
				>
					<annotations>
						<storage-algorithm>
							<query>
								<expr><![CDATA[catalog -> 
all(`fma:Material`).map( material -> 
        new(`fma:PartsGroup`, transient: true)
	..set(`fma:PartsGroup#name`, $material.get(`fma:Material#name`))
	..set(`fma:PartsGroup#parts`, 
	         $catalog.get(`fma:PartCatalog#parts`).filter(part -> $part.get(`fma:SinglePart#material`).containsElement($material))
	       )  
)
]]></expr>
							</query>
						</storage-algorithm>
						<create-visibility value="hidden"/>
						<visibility value="hidden"/>
					</annotations>
				</reference>
				<reference name="materialCompany"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="PartsGroup"
				>
					<annotations>
						<storage-algorithm>
							<query>
								<expr><![CDATA[catalog -> 
all(`fma:Company`).map( company -> 
    new(`fma:PartsGroup`, transient: true)
	  ..set(`fma:PartsGroup#name`, $company.get(`fma:Company#name`))
	  ..set(`fma:PartsGroup#parts`,      
		  all(`fma:Material`).map( material -> 
	         new(`fma:PartsGroup`, transient: true)
		       ..set(`fma:PartsGroup#name`, $material.get(`fma:Material#name`))
		       ..set(`fma:PartsGroup#parts`, 
		         $catalog.get(`fma:PartCatalog#parts`).filter(
		        	 part -> $part.get(`fma:SinglePart#material`).containsElement($material) && $part.get(`fma:SinglePart#company`)==$company
		        )
		   )  
	    ) 
     )
)]]></expr>
							</query>
						</storage-algorithm>
						<create-visibility value="hidden"/>
						<visibility value="hidden"/>
					</annotations>
				</reference>
			</attributes>
		</class>
		<class name="PartsGroup">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<attributes>
				<property name="name"
					type="tl.core:String"
				/>
				<reference name="parts"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="tl.model:TLObject"
				/>
			</attributes>
		</class>
		<class name="PartsListEntry">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<attributes>
				<reference name="part"
					kind="forwards"
					mandatory="true"
					navigate="true"
					type="SinglePart"
				/>
				<reference name="connections"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="Connection"
				/>
				<property name="count"
					type="tl.core:Integer"
				>
					<annotations>
						<storage-algorithm>
							<query expr="entry -> $entry.get(`fma:PartsListEntry#connections`).size()"/>
						</storage-algorithm>
					</annotations>
				</property>
				<property name="costs"
					type="tl.core:Double"
				>
					<annotations>
						<storage-algorithm>
							<query expr="entry -> $entry.get(`fma:PartsListEntry#part`).get(`fma:SinglePart#price`) * $entry.get(`fma:PartsListEntry#count`)"/>
						</storage-algorithm>
					</annotations>
				</property>
				<property name="singlePrice"
					type="tl.core:Double"
				>
					<annotations>
						<storage-algorithm>
							<query expr="entry -> $entry.get(`fma:PartsListEntry#part`).get(`fma:SinglePart#price`)"/>
						</storage-algorithm>
					</annotations>
				</property>
				<reference name="materials"
					kind="forwards"
					multiple="true"
					navigate="true"
					type="Material"
				>
					<annotations>
						<storage-algorithm>
							<query expr="entry -> $entry.get(`fma:PartsListEntry#part`).get(`fma:SinglePart#material`)"/>
						</storage-algorithm>
					</annotations>
				</reference>
				<reference name="producer"
					kind="forwards"
					navigate="true"
					type="Company"
				>
					<annotations>
						<storage-algorithm>
							<query expr="entry -> $entry.get(`fma:PartsListEntry#part`).get(`fma:SinglePart#company`)"/>
						</storage-algorithm>
					</annotations>
				</reference>
			</attributes>
		</class>
		<class name="Product">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<annotations>
				<form-definition>
					<form>
						<field
							attribute="name"
							fullQualifiedName="fma:Product#name"
							type="tl.core:String"
						/>
					</form>
				</form-definition>
			</annotations>
			<attributes>
				<reference name="buildGroup"
					composite="true"
					kind="forwards"
					mandatory="true"
					navigate="true"
					type="ConstructionGroup"
				/>
				<property name="name"
					mandatory="true"
					type="tl.core:String"
				/>
			</attributes>
		</class>
		<class name="ProductSelection">
			<generalizations>
				<generalization type="tl.model:TLObject"/>
			</generalizations>
			<annotations>
				<form-definition>
					<form>
						<field
							attribute="product"
							fullQualifiedName="fma:ProductSelection#product"
							type="fma:Product"
						/>
						<field
							attribute="rule"
							fullQualifiedName="fma:ProductSelection#rule"
							type="tl.core:String"
						/>
						<field
							attribute="referenceDate"
							fullQualifiedName="fma:ProductSelection#referenceDate"
							type="tl.core:DateTime"
						/>
					</form>
				</form-definition>
			</annotations>
			<attributes>
				<reference name="product"
					kind="forwards"
					mandatory="true"
					navigate="true"
					type="Product"
				/>
				<reference name="country"
					kind="forwards"
					navigate="true"
					type="Country"
				/>
				<property name="rule"
					type="tl.core:String"
				/>
				<property name="referenceDate"
					type="tl.core:DateTime"
				/>
			</attributes>
		</class>
	</module>
</model>